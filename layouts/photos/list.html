{{ define "additional-style" }}
{{ with resources.Get "css/photos-list.css" | toCSS | minify | fingerprint}}
    <style media="screen">{{ .Content | safeCSS }}</style>
{{ end }}
{{ end }}

{{ define "main" }}
<div class="post-list-photos">
    {{ range where $.Site.RegularPages "Section" "photos" }}

    <!-- Get image base path and type -->
    {{ $srcBase := .Site.Params.photosURL }}
    {{ $srcFile := index (findRE "^([^.]+)" .Params.src 1) 0 }}
    {{ $srcExt := index (findRE "\\.[^.]*$|$" .Params.src 1) 0 }}

    <!-- Fetch remote image to get dimensions -->
    {{ $imgURL := printf "%s/metadata=none/%s%s" $srcBase $srcFile $srcExt }}
    {{ $srcWidth := 0 }}
    {{ $srcHeight := 0 }}
    {{ with try (resources.GetRemote $imgURL) }}
      {{ with .Err }}
        {{ warnf "Failed to fetch %s: %s" $imgURL . }}
      {{ else with .Value }}
        {{ $srcWidth = .Width }}
        {{ $srcHeight = .Height }}
      {{ end }}
    {{ end }}

    {{ $aspectRatio := 1.5 }}
    {{ if and (gt $srcWidth 0) (gt $srcHeight 0) }}
      {{ $aspectRatio = div (mul $srcWidth 1.0) $srcHeight }}
    {{ end }}

    <figure class="photo-frame" style="flex-grow: {{ printf "%.4f" $aspectRatio }}; flex-basis: {{ printf "%.0f" (mul $aspectRatio 375) }}px;">
        <a href="{{ .RelPermalink }}">
            <picture>
                <source srcset="{{ $srcBase }}/width=320,metadata=none,format=webp/{{ $srcFile }}.webp 320w, {{ $srcBase }}/width=640,metadata=none,format=webp/{{ $srcFile }}.webp 640w, {{ $srcBase }}/width=960,metadata=none,format=webp/{{ $srcFile }}.webp 960w" sizes="100vw" type="image/webp">
                <source srcset="{{ $srcBase }}/width=320,metadata=none,format=jpeg/{{ $srcFile }}.jpg 320w, {{ $srcBase }}/width=640,metadata=none,format=jpeg/{{ $srcFile }}.jpg 640w, {{ $srcBase }}/width=960,metadata=none,format=jpeg/{{ $srcFile }}.jpg 960w" sizes="100vw" type="image/jpeg">
                <img src="{{ $srcBase }}/width=640,metadata=none/{{ $srcFile }}{{ $srcExt }}" alt="{{ .Title }}" width="{{ $srcWidth }}"
                  height="{{ $srcHeight }}" loading="lazy">
            </picture>
        </a>
        {{ if eq .Params.recommended "true" }}
        <figcaption class="photo-rec">
            {{ partial "heart" (dict "title" "Personal favorite" "width" "24px" "height" "24px" ) }}
        </figcaption>
        {{ end }}
    </figure>
    {{ end }}
    <div class="photo-spacer"></div>
</div>
{{ end }}