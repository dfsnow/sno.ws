{{ define "additional-style" }}
{{ with resources.Get "css/photos-single.css" | toCSS | minify | fingerprint}}
    <style media="screen">{{ .Content | safeCSS }}</style>
{{ end }}
{{ end }}

{{ define "main" }}

<!-- Get image base path and type -->
{{ $srcBase := .Site.Params.photosURL }}
{{ $srcFile := index (findRE "^([^.]+)" .Params.src 1) 0 }}
{{ $srcExt := index (findRE "\\.[^.]*$|$" .Params.src 1) 0 }}

<!-- Fetch remote image to get dimensions -->
{{ $imgURL := printf "%s/metadata=none/%s%s" $srcBase $srcFile $srcExt }}
{{ $srcWidth := 0 }}
{{ $srcHeight := 0 }}
{{ with try (resources.GetRemote $imgURL) }}
  {{ with .Err }}
    {{ warnf "Failed to fetch %s: %s" $imgURL . }}
  {{ else with .Value }}
    {{ $srcWidth = .Width }}
    {{ $srcHeight = .Height }}
  {{ end }}
{{ end }}

<figure class="post-feature-frame">
    <a href="{{ $srcBase }}/metadata=none,format=jpeg/{{ $srcFile }}{{ $srcExt }}">
        <picture>
            <source srcset="{{ $srcBase }}/width=640,metadata=none,format=webp/{{ $srcFile }}.webp 640w, {{ $srcBase }}/width=960,metadata=none,format=webp/{{ $srcFile }}.webp 960w, {{ $srcBase }}/width=1280,metadata=none,format=webp/{{ $srcFile }}.webp 1280w, {{ $srcBase }}/width=1920,metadata=none,format=webp/{{ $srcFile }}.webp 1920w" sizes="100vw" type="image/webp">
            <source srcset="{{ $srcBase }}/width=640,metadata=none,format=jpeg/{{ $srcFile }}.jpg 640w, {{ $srcBase }}/width=960,metadata=none,format=jpeg/{{ $srcFile }}.jpg 960w, {{ $srcBase }}/width=1280,metadata=none,format=jpeg/{{ $srcFile }}.jpg 1280w, {{ $srcBase }}/width=1920,metadata=none,format=jpeg/{{ $srcFile }}.jpg 1920w" sizes="100vw" type="image/jpeg">
            <img src="{{ $srcBase }}/width=640,metadata=none/{{ $srcFile }}{{ $srcExt }}" alt="{{ .Title }}" width="{{ $srcWidth }}"
                height="{{ $srcHeight }}" class="post-feature-photo">
        </picture>
    </a>
</figure>

<article>
    <header class="post-header">
        <h1 class="post-title">{{ .Title }}</h1>
        {{- if isset .Params "date" -}}
        <time class="post-meta" datetime='{{ .Date.Format "2006-01-02" }}'>{{ .Date.Format "January 2, 2006" }}</time>
        {{- end -}}
    </header>
    {{- .Content -}}
</article>
{{ end }}